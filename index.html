
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Solo Guy Cotten 2025 - Live Tracking</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #windy {
      position: absolute;
      top: 0;
      left: 250px;
      right: 0;
      bottom: 0;
    }
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 250px;
      background: #f4f4f4;
      padding: 10px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    .boat-item {
      margin: 5px 0;
      padding: 5px;
      cursor: pointer;
      border-left: 5px solid transparent;
    }
    .boat-item:hover {
      background: #eee;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
  <script src="https://api.windy.com/assets/map-forecast/libBoot.js"></script>
</head>
<body>
  <div id="sidebar"><h3>Skippers</h3><div id="boatList"></div></div>
  <div id="windy"></div>

  <script>
    const options = {
      key: 'HmMjBrCUlBFacsLNbgMK1ycyBYhjbEJn',
      verbose: true,
      lat: 47.5,
      lon: -4.1,
      zoom: 8,
    };

    const colors = [
      'red', 'blue', 'green', 'orange', 'purple', 'cyan', 'magenta', 'lime', 'teal', 'maroon',
      'navy', 'olive', 'darkgreen', 'chocolate', 'indigo', 'coral', 'tomato', 'gold', 'deepskyblue', 'hotpink'
    ];

    const parcours = [[47.84617, -3.95517], [47.76733, -4.012], [47.7575, -4.0675], [47.75532, -4.31867], [47.7745, -4.378], [47.79667, -4.39833], [48.03947, -4.7596], [48.36982, -5.07917], [48.06417, -5.13667], [47.64632, -4.02332], [46.84083, -3.1375], [47.48567, -3.29098], [47.70933, -3.83048], [47.79747, -3.89082], [47.84617, -3.95517]];

    windyInit(options, windyAPI => {
      const { map } = windyAPI;
      const boatList = document.getElementById("boatList");

      const parcoursLine = L.polyline(parcours, {
        color: "#FBCF15",
        weight: 3,
        dashArray: "5, 5"
      }).addTo(map);

      async function loadPositions() {
        try {
          const res = await fetch('https://solo.studiok37.com/proxy.php');
          const xmlText = await res.text();
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlText, "application/xml");

          if (window.markers) window.markers.forEach(m => map.removeLayer(m));
          if (window.tracks) window.tracks.forEach(t => map.removeLayer(t));
          window.markers = [];
          window.tracks = [];
          boatList.innerHTML = "";

          const devices = xml.querySelectorAll("Device");
          devices.forEach((device, i) => {
            const name = device.getAttribute("name") || "Unknown Boat";
            const positions = device.querySelectorAll("Position");
            if (!positions.length) return;

            const path = [];
            positions.forEach(pos => {
              const lat = parseFloat(pos.querySelector("Latitude").textContent);
              const lon = parseFloat(pos.querySelector("Longitude").textContent);
              path.push([lat, lon]);
            });

            const latest = positions[0]; // point le plus récent
            const lat = parseFloat(latest.querySelector("Latitude").textContent);
            const lon = parseFloat(latest.querySelector("Longitude").textContent);
            const sog = latest.querySelector("SOG")?.textContent || "N/A";
            const cog = latest.querySelector("COG")?.textContent || "N/A";
            const timeUTC = latest.querySelector("GpsAt")?.textContent || "N/A";

            const localTime = new Date(timeUTC);
            const optionsTime = {
              timeZone: 'Europe/Paris',
              hour: '2-digit',
              minute: '2-digit',
              day: '2-digit',
              month: '2-digit'
            };
            const localTimeStr = localTime.toLocaleString('fr-FR', optionsTime);

            const popup = `
              <b>${name}</b><br>
              <small>Dernier point : ${localTimeStr}</small><br>
              Lat: ${lat.toFixed(4)}<br>
              Lon: ${lon.toFixed(4)}<br>
              Vitesse: ${sog} kn<br>
              Cap: ${cog}°
            `;

            const boatIcon = L.divIcon({
              className: '',
              html: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="${colors[i % colors.length]}"><path d="M12 2C10.895 2 10 2.895 10 4V11.586L6.707 8.293C6.077 7.663 5 8.109 5 9V14.586L3.707 13.293C3.077 12.663 2 13.109 2 14V20C2 21.105 2.895 22 4 22H20C21.105 22 22 21.105 22 20V14C22 13.109 20.923 12.663 20.293 13.293L19 14.586V9C19 8.109 17.923 7.663 17.293 8.293L14 11.586V4C14 2.895 13.105 2 12 2Z"/></svg>`,
              iconSize: [20, 20],
              iconAnchor: [10, 10],
              popupAnchor: [0, -10]
            });

            const marker = L.marker([lat, lon], { icon: boatIcon }).addTo(map).bindPopup(popup);
            const polyline = L.polyline(path, {
              color: colors[i % colors.length],
              weight: 2
            }).addTo(map);

            const item = document.createElement("div");
            item.className = "boat-item";
            item.textContent = name;
            item.style.borderLeftColor = colors[i % colors.length];
            item.onclick = () => {
              map.setView([lat, lon], 10);
              marker.openPopup();
            };
            boatList.appendChild(item);

            window.markers.push(marker);
            window.tracks.push(polyline);
          });
        } catch (error) {
          console.error("Erreur lors du chargement des positions :", error);
        }
      }

      loadPositions();
      setInterval(loadPositions, 15 * 60 * 1000);
    });
  </script>
</body>
</html>
