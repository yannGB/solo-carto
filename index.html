
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Solo Guy Cotten 2025 - Tracking + Traces + Bateaux</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
    }
    #windy {
      width: 100%;
      height: 100vh;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
  <script src="https://api.windy.com/assets/map-forecast/libBoot.js"></script>
</head>
<body>
  <div id="windy"></div>

  <script>
    const options = {
      key: 'HmMjBrCUlBFacsLNbgMK1ycyBYhjbEJn', // bonne clé API Windy
      verbose: true,
      lat: 47.5,
      lon: -4.1,
      zoom: 8,
    };

    const colors = [
      'red', 'blue', 'green', 'orange', 'purple', 'cyan', 'magenta', 'lime', 'teal', 'maroon',
      'navy', 'olive', 'darkgreen', 'chocolate', 'indigo', 'coral', 'tomato', 'gold', 'deepskyblue', 'hotpink'
    ];

    windyInit(options, windyAPI => {
      const { map } = windyAPI;

      async function loadPositions() {
        try {
          const res = await fetch('https://solo.studiok37.com/proxy.php');
          const xmlText = await res.text();
          const parser = new DOMParser();
          const xml = parser.parseFromString(xmlText, "application/xml");

          if (window.markers) window.markers.forEach(marker => map.removeLayer(marker));
          if (window.tracks) window.tracks.forEach(track => map.removeLayer(track));
          window.markers = [];
          window.tracks = [];

          const devices = xml.querySelectorAll("Device");
          devices.forEach((device, i) => {
            const name = device.getAttribute("name") || "Unknown Boat";
            const positions = device.querySelectorAll("Position");
            if (!positions.length) return;

            const path = [];
            positions.forEach(pos => {
              const lat = parseFloat(pos.querySelector("Latitude").textContent);
              const lon = parseFloat(pos.querySelector("Longitude").textContent);
              path.push([lat, lon]);
            });

            const latest = positions[positions.length - 1];
            const lat = parseFloat(latest.querySelector("Latitude").textContent);
            const lon = parseFloat(latest.querySelector("Longitude").textContent);
            const sog = latest.querySelector("SOG")?.textContent || "N/A";
            const cog = latest.querySelector("COG")?.textContent || "N/A";
            const timeUTC = latest.querySelector("GpsAt")?.textContent || "N/A";

            const localTime = new Date(timeUTC);
            const optionsTime = {
              timeZone: 'Europe/Paris',
              hour: '2-digit',
              minute: '2-digit',
              day: '2-digit',
              month: '2-digit'
            };
            const localTimeStr = localTime.toLocaleString('fr-FR', optionsTime);

            const popup = `
              <b>${name}</b><br>
              <small>Dernier point : ${localTimeStr}</small><br>
              Lat: ${lat.toFixed(4)}<br>
              Lon: ${lon.toFixed(4)}<br>
              Vitesse: ${sog} kn<br>
              Cap: ${cog}°
            `;

            const boatIcon = L.divIcon({
              className: '',
              html: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="${colors[i % colors.length]}"><path d="M12 2C10.895 2 10 2.895 10 4V11.586L6.707 8.293C6.077 7.663 5 8.109 5 9V14.586L3.707 13.293C3.077 12.663 2 13.109 2 14V20C2 21.105 2.895 22 4 22H20C21.105 22 22 21.105 22 20V14C22 13.109 20.923 12.663 20.293 13.293L19 14.586V9C19 8.109 17.923 7.663 17.293 8.293L14 11.586V4C14 2.895 13.105 2 12 2Z"/></svg>`,
              iconSize: [20, 20],
              iconAnchor: [10, 10],
              popupAnchor: [0, -10]
            });

            const marker = L.marker([lat, lon], { icon: boatIcon }).addTo(map).bindPopup(popup);
            const polyline = L.polyline(path, {
              color: colors[i % colors.length],
              weight: 2
            }).addTo(map);

            window.markers.push(marker);
            window.tracks.push(polyline);
          });
        } catch (error) {
          console.error("Erreur lors du chargement des positions :", error);
        }
      }

      loadPositions();
      setInterval(loadPositions, 15 * 60 * 1000);
    });
  </script>
</body>
</html>
